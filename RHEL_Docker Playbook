---
- name: Install Docker and Portainer, remove Podman and Buildah
  become: true
  tasks:
    - name: Remove Podman and Buildah
      yum:
        name: "{{ item }}"
        state: absent
      loop:
        - podman
        - buildah
      when: ansible_distribution_major_version == '9' and ansible_distribution_version | version_compare('9.2', '<')

    - name: Install required packages
      yum:
        name: "{{ item }}"
        state: present
      loop:
        - docker
        - docker-ce-cli
        - containerd.io

    - name: Enable and start Docker service
      service:
        name: docker
        state: started
        enabled: true

    - name: Add Docker GPG key
      rpm_key:
        key: https://download.docker.com/linux/{{ ansible_distribution|lower }}/gpg

    - name: Add Docker repository
      yum_repository:
        name: docker
        baseurl: https://download.docker.com/linux/{{ ansible_distribution|lower }}/{{ ansible_distribution_major_version }}/x86_64/stable
        gpgcheck: yes
        enabled: yes
        gpgkey: https://download.docker.com/linux/{{ ansible_distribution|lower }}/gpg

    - name: Install Portainer
      docker_container:
        name: portainer
        image: portainer/portainer-ce:latest
        restart_policy: unless-stopped
        published_ports:
          - 9000:9000
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
        state: started
